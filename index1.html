<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ | –Æ–Ω–∏—Ç-—ç–∫–æ–Ω–æ–º–∏–∫–∞ –¥–ª—è –º–∞–ª–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞</title>
    <meta name="description" content="–†–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å, –º–∞—Ä–∂—É –∏ —Ç–æ—á–∫—É –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏ –≤–∞—à–µ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞. –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è handmade –∏ –º–∏–∫—Ä–æ-–±–∏–∑–Ω–µ—Å–∞.">
    
    <!-- Chart.js –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- EmailJS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <style>
        /* ========== –°–û–í–†–ï–ú–ï–ù–ù–´–ô –î–ò–ó–ê–ô–ù ========== */
        :root {
            /* –ú—è–≥–∫–∞—è, –ø—Ä–∏—è—Ç–Ω–∞—è —Ü–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞ */
            --primary: #6366f1;        /* –ú—è–≥–∫–∏–π –∏–Ω–¥–∏–≥–æ */
            --primary-dark: #4f46e5;    /* –ù–∞—Å—ã—â–µ–Ω–Ω—ã–π –∏–Ω–¥–∏–≥–æ */
            --primary-light: #a5b4fc;    /* –°–≤–µ—Ç–ª—ã–π –∏–Ω–¥–∏–≥–æ */
            --primary-soft: #eef2ff;     /* –û—á–µ–Ω—å —Å–≤–µ—Ç–ª—ã–π –∏–Ω–¥–∏–≥–æ */
            
            --success: #10b981;          /* –ú—è—Ç–Ω—ã–π */
            --success-soft: #d1fae5;      /* –°–≤–µ—Ç–ª–æ-–º—è—Ç–Ω—ã–π */
            --warning: #f59e0b;           /* –¢–µ–ø–ª—ã–π –æ—Ä–∞–Ω–∂–µ–≤—ã–π */
            --warning-soft: #fef3c7;      /* –°–≤–µ—Ç–ª–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π */
            --danger: #ef4444;             /* –ú—è–≥–∫–∏–π –∫—Ä–∞—Å–Ω—ã–π */
            --danger-soft: #fee2e2;        /* –°–≤–µ—Ç–ª–æ-–∫—Ä–∞—Å–Ω—ã–π */
            
            /* –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ —Ç–æ–Ω–∞ –¥–ª—è –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è */
            --bg: #faf9f6;                 /* –¢–µ–ø–ª—ã–π –±–µ–ª—ã–π (–æ—á–µ–Ω—å –º—è–≥–∫–∏–π) */
            --bg-card: #ffffff;             /* –ß–∏—Å—Ç—ã–π –±–µ–ª—ã–π */
            --text: #2c3e50;                /* –¢–µ–º–Ω–æ-—Å–∏–Ω–µ-—Å–µ—Ä—ã–π –¥–ª—è —Ç–µ–∫—Å—Ç–∞ */
            --text-muted: #6b7a8f;          /* –ú—è–≥–∫–∏–π —Å–µ—Ä–æ-—Å–∏–Ω–∏–π */
            --text-light: #95a5a6;           /* –°–≤–µ—Ç–ª—ã–π —Å–µ—Ä—ã–π */
            --border: #e9eef2;               /* –û—á–µ–Ω—å –º—è–≥–∫–∏–π —Å–µ—Ä—ã–π */
            
            --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.01);
            
            --radius-sm: 12px;
            --radius-md: 16px;
            --radius-lg: 24px;
            
            --transition: all 0.2s ease;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text);
            background: var(--bg);
            padding: 24px;
        }
        
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* ========== MODERN HEADER ========== */
        header {
            text-align: center;
            padding: 48px 24px;
            margin-bottom: 32px;
            background: linear-gradient(135deg, var(--primary-soft) 0%, #ffffff 100%);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(99,102,241,0.03) 0%, transparent 70%);
            pointer-events: none;
        }
        
        header h1 {
            font-size: 2.2rem;
            margin-bottom: 16px;
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
        }
        
        header p {
            color: var(--text-muted);
            font-size: 1.2rem;
            max-width: 600px;
            margin: 0 auto;
            position: relative;
        }
        
        .badge {
            display: inline-block;
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary-dark);
            padding: 6px 16px;
            border-radius: 40px;
            font-size: 0.9rem;
            font-weight: 500;
            margin-top: 20px;
            border: 1px solid var(--primary-light);
            backdrop-filter: blur(5px);
        }
        
        /* ========== MODERN CARDS ========== */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 28px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
        }
        
        .card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--primary-light);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border);
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: var(--primary);
            border-radius: 4px;
        }
        
        /* ========== MODERN FORM ========== */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text);
            letter-spacing: -0.01em;
        }
        
        .form-group small {
            display: block;
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-top: 6px;
            line-height: 1.4;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.95rem;
            transition: var(--transition);
            background: var(--bg);
            color: var(--text);
        }
        
        .form-group input:hover, .form-group select:hover {
            border-color: var(--primary-light);
        }
        
        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 4px var(--primary-soft);
        }
        
        .input-with-unit {
            display: flex;
            gap: 8px;
        }
        
        .input-with-unit input {
            flex: 1;
        }
        
        .input-with-unit span {
            padding: 12px 16px;
            background: var(--primary-soft);
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--primary-dark);
            font-size: 0.95rem;
            font-weight: 500;
            white-space: nowrap;
        }
        
        /* ========== SECTION TITLES ========== */
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 32px 0 20px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title::after {
            content: '';
            flex: 1;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-light), transparent);
            margin-left: 16px;
        }
        
        /* ========== COST BREAKDOWN ========== */
        .cost-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px dashed var(--border);
        }
        
        .cost-item:last-child {
            border-bottom: none;
        }
        
        .cost-item .label {
            color: var(--text-muted);
        }
        
        .cost-item .value {
            font-weight: 500;
            color: var(--text);
        }
        
        .cost-item.total {
            background: var(--primary-soft);
            padding: 16px;
            border-radius: var(--radius-sm);
            margin-top: 16px;
            border: 1px solid var(--primary-light);
        }
        
        .cost-item.total .value {
            color: var(--primary-dark);
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        /* ========== MODERN METRICS ========== */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 24px 0;
        }
        
        .metric-card {
            background: var(--bg);
            padding: 24px 16px;
            border-radius: var(--radius-md);
            text-align: center;
            border: 1.5px solid var(--border);
            transition: var(--transition);
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            border-color: var(--primary-light);
            box-shadow: var(--shadow-md);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
            margin: 8px 0;
            line-height: 1.2;
        }
        
        .metric-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }
        
        .metric-card.success .metric-value { color: var(--success); }
        .metric-card.warning .metric-value { color: var(--warning); }
        .metric-card.danger .metric-value { color: var(--danger); }
        
        /* ========== CHARTS ========== */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 24px;
            margin: 24px 0;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            padding: 8px;
        }
        
        /* ========== MODERN BUTTONS ========== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 28px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            border: 1.5px solid transparent;
        }
        
        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 8px 16px -4px rgba(99, 102, 241, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn.secondary {
            background: white;
            color: var(--text);
            border-color: var(--border);
        }
        
        .btn.secondary:hover {
            background: var(--bg);
            border-color: var(--primary-light);
        }
        
        .btn.success {
            background: var(--success);
            color: white;
        }
        
        .btn.success:hover {
            background: #0d9668;
        }
        
        .btn.outline {
            background: transparent;
            border: 1.5px solid var(--primary);
            color: var(--primary);
        }
        
        .btn.outline:hover {
            background: var(--primary-soft);
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .btn-group {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-top: 32px;
        }
        
        /* ========== RECOMMENDATIONS & RISKS ========== */
        .recommendations {
            background: var(--primary-soft);
            border: 1px solid var(--primary-light);
            border-radius: var(--radius-md);
            padding: 24px;
            margin: 24px 0;
        }
        
        .recommendations h4 {
            color: var(--primary-dark);
            margin-bottom: 16px;
            font-size: 1.1rem;
        }
        
        .recommendations ul {
            padding-left: 24px;
            color: var(--text);
        }
        
        .recommendations li {
            margin: 8px 0;
            line-height: 1.5;
        }
        
        .risk-card {
            background: var(--danger-soft);
            border: 1px solid #fecaca;
            border-radius: var(--radius-sm);
            padding: 20px;
            margin: 12px 0;
            border-left: 4px solid var(--danger);
        }
        
        .risk-card strong {
            color: var(--danger);
            display: block;
            margin-bottom: 8px;
            font-size: 1rem;
        }
        
        .risk-card p {
            margin: 8px 0;
            font-size: 0.95rem;
            color: var(--text);
        }
        
        .risk-card .mitigation {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed rgba(239, 68, 68, 0.3);
            color: var(--success);
        }
        
        .risk-card .mitigation::before {
            content: "‚úÖ ";
        }
        
        /* ========== EMAIL SECTION ========== */
        .email-section {
            background: linear-gradient(135deg, var(--primary-soft), white);
            border: 1.5px solid var(--primary-light);
            border-radius: var(--radius-md);
            padding: 28px;
            margin: 28px 0;
        }
        
        .email-section h4 {
            color: var(--primary-dark);
            margin-bottom: 16px;
            font-size: 1.2rem;
        }
        
        .email-note {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        /* ========== EXPORT PREVIEW ========== */
        .export-preview {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: var(--radius-sm);
            font-family: 'Fira Code', monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            margin: 16px 0;
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #334155;
        }
        
        /* ========== LOADING ========== */
        .loading {
            display: none;
            text-align: center;
            padding: 48px;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            width: 56px;
            height: 56px;
            border: 3px solid var(--primary-soft);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.4, 0, 0.2, 1) infinite;
            margin: 0 auto 24px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ========== MODERN TOOLTIP ========== */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            margin-left: 6px;
        }
        
        .tooltip .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: var(--text-muted);
            color: white;
            border-radius: 50%;
            font-size: 0.7rem;
            font-weight: bold;
            transition: var(--transition);
        }
        
        .tooltip:hover .tooltip-icon {
            background: var(--primary);
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 280px;
            background: var(--text);
            color: white;
            text-align: left;
            border-radius: var(--radius-sm);
            padding: 16px;
            position: absolute;
            z-index: 100;
            bottom: 150%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.2s, visibility 0.2s;
            font-size: 0.85rem;
            font-weight: normal;
            line-height: 1.5;
            box-shadow: var(--shadow-lg);
            pointer-events: none;
        }
        
        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--text) transparent transparent transparent;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* ========== FOOTER ========== */
        footer {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
            font-size: 0.9rem;
            border-top: 1px solid var(--border);
            margin-top: 48px;
        }
        
        footer a {
            color: var(--primary);
            text-decoration: none;
            transition: var(--transition);
        }
        
        footer a:hover {
            color: var(--primary-dark);
            text-decoration: underline;
        }
        
        /* ========== RESPONSIVE ========== */
        @media (max-width: 768px) {
            body { padding: 16px; }
            
            header { padding: 32px 16px; }
            header h1 { font-size: 1.8rem; }
            
            .form-grid { grid-template-columns: 1fr; }
            .charts-grid { grid-template-columns: 1fr; }
            .btn-group { flex-direction: column; }
            .btn { width: 100%; }
            
            .metric-value { font-size: 1.6rem; }
        }
        
        /* ========== PRINT STYLES ========== */
        @media print {
            .no-print { display: none !important; }
            body { background: white; padding: 16px; }
            .card { box-shadow: none; border: 1px solid #ddd; break-inside: avoid; }
            #resultsSection { display: block !important; }
        }
        
        /* ========== ANIMATIONS ========== */
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        #resultsSection {
            display: none;
        }
        
        #resultsSection.show {
            display: block;
            animation: slideUp 0.4s ease-out;
        }
        
        /* ========== CUSTOM SCROLLBAR ========== */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary-light);
            border-radius: 20px;
            border: 2px solid var(--bg);
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        /* ========== GRADIENT TEXT ========== */
        .gradient-text {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Modern Header -->
    <header>
        <h1>üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏</h1>
        <p>–†–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ —Ä–µ–∞–ª—å–Ω—É—é –ø—Ä–∏–±—ã–ª—å –≤–∞—à–µ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞: —É—á—Ç–∏—Ç–µ –≤—Å–µ —Ä–∞—Å—Ö–æ–¥—ã, –º–∞—Ä–∂—É –∏ —Ç–æ—á–∫—É –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏</p>
        <span class="badge">‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω ‚Ä¢ üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV</span>
    </header>

    <!-- Calculator Form -->
    <div class="card no-print">
        <div class="card-header">
            <h2 class="card-title">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–æ–¥—É–∫—Ç–∞</h2>
            <button type="button" class="btn outline" onclick="loadSampleData()" style="padding: 10px 20px;">üéØ –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏–º–µ—Ä</button>
        </div>
        
        <form id="calcForm">
            <div class="form-grid">
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞</label>
                    <input type="text" id="productName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ù–∞—Ç—É—Ä–∞–ª—å–Ω–æ–µ –º—ã–ª–æ –õ–∞–≤–∞–Ω–¥–∞" required>
                </div>
                <div class="form-group">
                    <label>–ü–ª–∞–Ω–∏—Ä—É–µ–º–∞—è —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏ (‚ÇΩ)</label>
                    <div class="input-with-unit">
                        <input type="number" id="sellingPrice" step="0.01" min="0" placeholder="0.00" required>
                        <span>‚ÇΩ</span>
                    </div>
                    <small>–¶–µ–Ω–∞, –ø–æ –∫–æ—Ç–æ—Ä–æ–π –±—É–¥–µ—Ç–µ –ø—Ä–æ–¥–∞–≤–∞—Ç—å –ø–æ–∫—É–ø–∞—Ç–µ–ª—é</small>
                </div>
            </div>

            <!-- Material Costs -->
            <h3 class="section-title">üì¶ –ú–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã (–Ω–∞ 1 –µ–¥–∏–Ω–∏—Ü—É)</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>–°—ã—Ä—å—ë –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã <span class="tooltip"><span class="tooltip-icon">?</span><span class="tooltip-text">–°—Ç–æ–∏–º–æ—Å—Ç—å –≤—Å–µ—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤/–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∏–∑–¥–µ–ª–∏—è</span></span></label>
                    <div class="input-with-unit">
                        <input type="number" id="materialsCost" step="0.01" min="0" placeholder="0.00" value="0">
                        <span>‚ÇΩ</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>–£–ø–∞–∫–æ–≤–∫–∞ <span class="tooltip"><span class="tooltip-icon">?</span><span class="tooltip-text">–ö–æ—Ä–æ–±–∫–∞, –ø–ª—ë–Ω–∫–∞, –±–∏—Ä–∫–∞, —Å—Ç–∏–∫–µ—Ä –∏ —Ç.–¥.</span></span></label>
                    <div class="input-with-unit">
                        <input type="number" id="packagingCost" step="0.01" min="0" placeholder="0.00" value="0">
                        <span>‚ÇΩ</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>–î—Ä—É–≥–∏–µ –ø—Ä—è–º—ã–µ —Ä–∞—Å—Ö–æ–¥—ã</label>
                    <div class="input-with-unit">
                        <input type="number" id="otherDirectCosts" step="0.01" min="0" placeholder="0.00" value="0">
                        <span>‚ÇΩ</span>
                    </div>
                    <small>–î–æ—Å—Ç–∞–≤–∫–∞ —Å—ã—Ä—å—è, –∫–æ–º–∏—Å—Å–∏–∏ –ø–ª–∞—Ç—ë–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º –∏ —Ç.–ø.</small>
                </div>
            </div>

            <!-- Labor Costs -->
            <h3 class="section-title">‚è±Ô∏è –¢—Ä—É–¥–æ–≤—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>–í—Ä–µ–º—è –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ (–º–∏–Ω)</label>
                    <input type="number" id="laborMinutes" min="0" placeholder="0" value="0">
                </div>
                <div class="form-group">
                    <label>–°—Ç–æ–∏–º–æ—Å—Ç—å –≤–∞—à–µ–≥–æ —á–∞—Å–∞ (‚ÇΩ) <span class="tooltip"><span class="tooltip-icon">?</span><span class="tooltip-text">–ö–∞–∫—É—é —Å—É–º–º—É –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç—å –∑–∞ —á–∞—Å —Ä–∞–±–æ—Ç—ã. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –º–∏–Ω–∏–º—É–º: 300-500‚ÇΩ/—á–∞—Å –¥–ª—è handmade</span></span></label>
                    <div class="input-with-unit">
                        <input type="number" id="laborRate" step="0.01" min="0" placeholder="0.00" value="300">
                        <span>‚ÇΩ/—á–∞—Å</span>
                    </div>
                </div>
            </div>

            <!-- Overhead -->
            <h3 class="section-title">üè¢ –ù–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã (–≤ –º–µ—Å—è—Ü)</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>–ê—Ä–µ–Ω–¥–∞ / –∫–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ</label>
                    <div class="input-with-unit">
                        <input type="number" id="overheadRent" step="0.01" min="0" placeholder="0.00" value="0">
                        <span>‚ÇΩ/–º–µ—Å</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥ –∏ —Ä–µ–∫–ª–∞–º–∞</label>
                    <div class="input-with-unit">
                        <input type="number" id="overheadMarketing" step="0.01" min="0" placeholder="0.00" value="0">
                        <span>‚ÇΩ/–º–µ—Å</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>–ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã</label>
                    <div class="input-with-unit">
                        <input type="number" id="overheadOther" step="0.01" min="0" placeholder="0.00" value="0">
                        <span>‚ÇΩ/–º–µ—Å</span>
                    </div>
                    <small>–ë–∞–Ω–∫–æ–≤—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ, —Å–æ—Ñ—Ç, –∞–º–æ—Ä—Ç–∏–∑–∞—Ü–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</small>
                </div>
                <div class="form-group">
                    <label>–ü–ª–∞–Ω–∏—Ä—É–µ–º—ã–π –æ–±—ä—ë–º –ø—Ä–æ–¥–∞–∂ (—à—Ç/–º–µ—Å) <span class="tooltip"><span class="tooltip-icon">?</span><span class="tooltip-text">–°–∫–æ–ª—å–∫–æ –µ–¥–∏–Ω–∏—Ü –ø—Ä–æ–¥—É–∫—Ç–∞ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –ø—Ä–æ–¥–∞–≤–∞—Ç—å –≤ –º–µ—Å—è—Ü –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤</span></span></label>
                    <input type="number" id="monthlyVolume" min="1" placeholder="0" value="50" required>
                </div>
            </div>

            <!-- Marketplace -->
            <h3 class="section-title">üõí –ö–æ–º–∏—Å—Å–∏–∏ –∏ –ª–æ–≥–∏—Å—Ç–∏–∫–∞</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>–ö–æ–º–∏—Å—Å–∏—è –ø–ª–æ—â–∞–¥–∫–∏ (%)</label>
                    <div class="input-with-unit">
                        <input type="number" id="marketplaceFee" step="0.1" min="0" max="100" placeholder="0.0" value="0">
                        <span>%</span>
                    </div>
                    <small>Ozon ~5-15%, WB ~10-25%, —Å–≤–æ–π —Å–∞–π—Ç ~0-3%</small>
                </div>
                <div class="form-group">
                    <label>–õ–æ–≥–∏—Å—Ç–∏–∫–∞ –¥–æ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è (‚ÇΩ)</label>
                    <div class="input-with-unit">
                        <input type="number" id="shippingCost" step="0.01" min="0" placeholder="0.00" value="0">
                        <span>‚ÇΩ</span>
                    </div>
                    <small>–°—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ –æ–¥–Ω–æ–π –µ–¥–∏–Ω–∏—Ü—ã</small>
                </div>
                <div class="form-group">
                    <label>–ù–∞–ª–æ–≥–∏ (%) <span class="tooltip"><span class="tooltip-icon">?</span><span class="tooltip-text">–£–°–ù 6%, –ù–ü–î 4-6%, –∏–ª–∏ 0% –µ—Å–ª–∏ –ø–æ–∫–∞ –Ω–µ –ø–ª–∞—Ç–∏—Ç–µ</span></span></label>
                    <div class="input-with-unit">
                        <input type="number" id="taxRate" step="0.1" min="0" max="100" placeholder="0.0" value="6">
                        <span>%</span>
                    </div>
                </div>
            </div>

            <!-- Email -->
            <div class="form-group" style="margin-top: 32px; padding-top: 24px; border-top: 2px solid var(--border);">
                <label>üìß Email –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <input type="email" id="userEmail" placeholder="your@email.com" pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$">
                <small>–ü–æ–ª—É—á–∏—Ç–µ —Ä–∞—Å—á—ë—Ç + —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ + —á–µ–∫-–ª–∏—Å—Ç –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏</small>
            </div>

            <div class="btn-group">
                <button type="submit" class="btn">üöÄ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —é–Ω–∏—Ç-—ç–∫–æ–Ω–æ–º–∏–∫—É</button>
                <button type="button" class="btn secondary" onclick="resetForm()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</button>
                <button type="button" class="btn outline" onclick="window.print()">üñ®Ô∏è –ü–µ—á–∞—Ç—å / PDF</button>
            </div>
        </form>
    </div>

    <!-- Loading -->
    <div id="loading" class="loading card">
        <div class="spinner"></div>
        <p style="color: var(--text-muted);">–°—á–∏—Ç–∞–µ–º –≤–∞—à—É –ø—Ä–∏–±—ã–ª—å... <br><small style="font-size: 0.9rem;">–≠—Ç–æ –∑–∞–π–º—ë—Ç –º–µ–Ω—å—à–µ —Å–µ–∫—É–Ω–¥—ã</small></p>
    </div>

    <!-- Results -->
    <div id="resultsSection">
        <!-- Key Metrics -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">–ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>
                <span id="productTitle" style="font-size: 1rem; color: var(--text-muted);"></span>
            </div>
            
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å</div>
                    <div class="metric-value" id="costPerUnit">0 ‚ÇΩ</div>
                    <small style="color: var(--text-muted);">–Ω–∞ 1 –µ–¥–∏–Ω–∏—Ü—É</small>
                </div>
                <div class="metric-card success">
                    <div class="metric-label">–ú–∞—Ä–∂–∞</div>
                    <div class="metric-value" id="marginPercent">0%</div>
                    <small style="color: var(--text-muted);">—á–∏—Å—Ç–æ–π –ø—Ä–∏–±—ã–ª–∏</small>
                </div>
                <div class="metric-card">
                    <div class="metric-label">–ù–∞—Ü–µ–Ω–∫–∞</div>
                    <div class="metric-value" id="markupPercent">0%</div>
                    <small style="color: var(--text-muted);">–∫ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏</small>
                </div>
                <div class="metric-card warning">
                    <div class="metric-label">–¢–æ—á–∫–∞ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏</div>
                    <div class="metric-value" id="breakEvenUnits">0</div>
                    <small style="color: var(--text-muted);">—à—Ç—É–∫ –≤ –º–µ—Å—è—Ü</small>
                </div>
            </div>

            <!-- Cost Breakdown -->
            <h3 class="section-title">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏</h3>
            <div id="costBreakdown"></div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <div class="card">
                <h3 class="card-title" style="margin-bottom: 16px;">–î–æ–ª–∏ –∑–∞—Ç—Ä–∞—Ç</h3>
                <div class="chart-container">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h3 class="card-title" style="margin-bottom: 16px;">–ü—Ä–∏–±—ã–ª—å –ø—Ä–∏ —Ä–∞–∑–Ω–æ–º –æ–±—ä—ë–º–µ</h3>
                <div class="chart-container">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Recommendations -->
        <div class="recommendations">
            <h4>üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö</h4>
            <ul id="recommendationsList"></ul>
        </div>

        <!-- Risks -->
        <div class="card">
            <h3 class="card-title" style="color: var(--warning);">‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–∏—Å–∫–∏</h3>
            <div id="risksList"></div>
        </div>

        <!-- Email Export -->
        <div class="email-section no-print" id="emailSection" style="display: none;">
            <h4>üì¨ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç –Ω–∞ –ø–æ—á—Ç—É?</h4>
            <p class="email-note">–í—ã –ø–æ–ª—É—á–∏—Ç–µ: –¥–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç –≤ PDF + —á–µ–∫-–ª–∏—Å—Ç –ø–æ —Å–Ω–∏–∂–µ–Ω–∏—é —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ + —à–∞–±–ª–æ–Ω Excel –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —É—á—ë—Ç–∞</p>
            <button class="btn success btn-block" id="sendEmailBtn" onclick="sendEmail()">‚ú® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ <span id="emailDisplay"></span></button>
            <small style="display:block; margin-top:12px; color:var(--text-muted);">–ò—Å–ø–æ–ª—å–∑—É–µ–º EmailJS ‚Äî –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ</small>
        </div>

        <!-- CSV Export -->
        <div class="card no-print">
            <h3 class="card-title">üì• –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
            <p style="margin: 12px 0; color: var(--text-muted);">–°–∫–∞—á–∞–π—Ç–µ —Ä–∞—Å—á—ë—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ CSV –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –≤ Excel/Google –¢–∞–±–ª–∏—Ü—ã</p>
            <button class="btn outline" onclick="exportCSV(event)">üìä –°–∫–∞—á–∞—Ç—å CSV</button>
            <div class="export-preview" id="csvPreview" style="display: none; margin-top: 16px;"></div>
        </div>
    </div>

    <!-- Educational Block -->
    <div class="card no-print">
        <h3 class="card-title">–ö—Ä–∞—Ç–∫–∏–π –≥–∏–¥ –ø–æ —é–Ω–∏—Ç-—ç–∫–æ–Ω–æ–º–∏–∫–µ</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px; margin-top: 20px;">
            <div style="background: var(--bg); padding: 20px; border-radius: var(--radius-sm);">
                <strong style="color: var(--primary);">üéØ –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –µ–¥–∏–Ω–∏—Ü—ã</strong>
                <p style="color: var(--text-muted); margin-top: 8px;">–í—Å–µ –ø—Ä—è–º—ã–µ –∏ –∫–æ—Å–≤–µ–Ω–Ω—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã, –¥–µ–ª—ë–Ω–Ω—ã–µ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–∏–∑–≤–µ–¥—ë–Ω–Ω—ã—Ö –µ–¥–∏–Ω–∏—Ü. –ë–∞–∑–∞ –¥–ª—è —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è.</p>
            </div>
            <div style="background: var(--bg); padding: 20px; border-radius: var(--radius-sm);">
                <strong style="color: var(--primary);">üí∞ –ú–∞—Ä–∂–∞ vs –ù–∞—Ü–µ–Ω–∫–∞</strong>
                <p style="color: var(--text-muted); margin-top: 8px;">–ú–∞—Ä–∂–∞ = (–ü—Ä–∏–±—ã–ª—å / –í—ã—Ä—É—á–∫–∞) √ó 100%. –ù–∞—Ü–µ–Ω–∫–∞ = (–ü—Ä–∏–±—ã–ª—å / –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å) √ó 100%. –ú–∞—Ä–∂–∞ –≤—Å–µ–≥–¥–∞ –º–µ–Ω—å—à–µ –Ω–∞—Ü–µ–Ω–∫–∏.</p>
            </div>
            <div style="background: var(--bg); padding: 20px; border-radius: var(--radius-sm);">
                <strong style="color: var(--primary);">üìâ –¢–æ—á–∫–∞ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏</strong>
                <p style="color: var(--text-muted); margin-top: 8px;">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä—ë–º –ø—Ä–æ–¥–∞–∂, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º –¥–æ—Ö–æ–¥—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç –≤—Å–µ —Ä–∞—Å—Ö–æ–¥—ã. –ù–∏–∂–µ ‚Äî —É–±—ã—Ç–æ–∫, –≤—ã—à–µ ‚Äî –ø—Ä–∏–±—ã–ª—å.</p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <p><strong>–û—Ç–∫–∞–∑ –æ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:</strong> –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –æ—Ü–µ–Ω–æ—á–Ω—ã–µ —Ä–∞—Å—á—ë—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–≤–µ–¥—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö. –ù–µ —è–≤–ª—è–µ—Ç—Å—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –∏–ª–∏ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–µ–π.</p>
        <p style="margin-top: 16px;">
            <a href="#" onclick="alert('–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥: https://github.com/Nlilitary/unit-economics-calculator'); return false;">üíª –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –Ω–∞ GitHub</a> ‚Ä¢ 
            <a href="#" onclick="window.print(); return false;">üñ®Ô∏è –í–µ—Ä—Å–∏—è –¥–ª—è –ø–µ—á–∞—Ç–∏</a> ‚Ä¢ 
            <a href="web.telegram.org/@nilitary">‚úâÔ∏è –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —É–ª—É—á—à–µ–Ω–∏–µ</a>
        </p>
    </footer>
</div>

<script>
// [JavaScript –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π - –æ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—á–∏–π]
// ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
let calcResults = {
    productName: '',
    sellingPrice: 0,
    totalCostPerUnit: 0,
    margin: 0,
    markup: 0,
    breakEvenUnits: 0,
    roi: 0,
    breakdown: {},
    userEmail: ''
};

let pieChartInstance = null;
let barChartInstance = null;
let isCalculated = false;

// EmailJS init
(function(){
    if (typeof emailjs !== 'undefined') {
        emailjs.init("YOUR_PUBLIC_KEY");
    }
})();

// Utilities
const fmt = (num, decimals = 2) => new Intl.NumberFormat('ru-RU', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }).format(num);
const fmtInt = (num) => new Intl.NumberFormat('ru-RU').format(Math.round(num));
const parseNum = (val) => {
    const parsed = parseFloat(val);
    return isNaN(parsed) ? 0 : parsed;
};

// Sample Data
function loadSampleData() {
    document.getElementById('productName').value = '–ù–∞—Ç—É—Ä–∞–ª—å–Ω–æ–µ –º—ã–ª–æ "–õ–∞–≤–∞–Ω–¥–∞"';
    document.getElementById('sellingPrice').value = '350';
    document.getElementById('materialsCost').value = '85';
    document.getElementById('packagingCost').value = '25';
    document.getElementById('otherDirectCosts').value = '10';
    document.getElementById('laborMinutes').value = '20';
    document.getElementById('laborRate').value = '400';
    document.getElementById('overheadRent').value = '5000';
    document.getElementById('overheadMarketing').value = '3000';
    document.getElementById('overheadOther').value = '2000';
    document.getElementById('monthlyVolume').value = '80';
    document.getElementById('marketplaceFee').value = '12';
    document.getElementById('shippingCost').value = '150';
    document.getElementById('taxRate').value = '6';
    
    document.querySelector('#calcForm .btn').scrollIntoView({ behavior: 'smooth', block: 'center' });
    
    const btn = document.querySelector('#calcForm .btn');
    const original = btn.innerHTML;
    btn.innerHTML = '‚úÖ –ü—Ä–∏–º–µ—Ä –∑–∞–≥—Ä—É–∂–µ–Ω! –ù–∞–∂–º–∏—Ç–µ "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å"';
    setTimeout(() => btn.innerHTML = original, 2000);
}

// Calculation Logic
function calculateUnitEconomics(data) {
    const directMaterials = parseNum(data.materialsCost);
    const directPackaging = parseNum(data.packagingCost);
    const directOther = parseNum(data.otherDirectCosts);
    const directCosts = directMaterials + directPackaging + directOther;
    
    const laborHours = parseNum(data.laborMinutes) / 60;
    const laborCost = laborHours * parseNum(data.laborRate);
    
    const totalOverhead = parseNum(data.overheadRent) + parseNum(data.overheadMarketing) + parseNum(data.overheadOther);
    const monthlyVolume = Math.max(1, parseNum(data.monthlyVolume));
    const overheadPerUnit = totalOverhead / monthlyVolume;
    
    const sellingPrice = parseNum(data.sellingPrice);
    const marketplaceFee = (sellingPrice * parseNum(data.marketplaceFee)) / 100;
    const shippingCost = parseNum(data.shippingCost);
    const taxAmount = (sellingPrice * parseNum(data.taxRate)) / 100;
    
    const totalCostPerUnit = directCosts + laborCost + overheadPerUnit + marketplaceFee + shippingCost;
    const grossProfit = sellingPrice - totalCostPerUnit;
    const netProfit = grossProfit - taxAmount;
    
    const margin = sellingPrice > 0 ? (netProfit / sellingPrice) * 100 : 0;
    const markup = totalCostPerUnit > 0 ? ((sellingPrice - totalCostPerUnit) / totalCostPerUnit) * 100 : 0;
    
    const contributionMargin = sellingPrice - totalCostPerUnit - taxAmount;
    let breakEvenUnits;
    
    if (contributionMargin <= 0) {
        breakEvenUnits = Infinity;
    } else {
        breakEvenUnits = totalOverhead / contributionMargin;
    }
    
    const roi = totalCostPerUnit > 0 ? (netProfit / totalCostPerUnit) * 100 : 0;
    
    return {
        directCosts, laborCost, overheadPerUnit, marketplaceFee, shippingCost, taxAmount,
        totalCostPerUnit, sellingPrice, grossProfit, netProfit,
        margin, markup, breakEvenUnits, roi, contributionMargin,
        breakdown: {
            '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã': directMaterials,
            '–£–ø–∞–∫–æ–≤–∫–∞': directPackaging,
            '–ü—Ä–æ—á–∏–µ –ø—Ä—è–º—ã–µ': directOther,
            '–¢—Ä—É–¥': laborCost,
            '–ù–∞–∫–ª–∞–¥–Ω—ã–µ': overheadPerUnit,
            '–ö–æ–º–∏—Å—Å–∏—è –ø–ª–æ—â–∞–¥–∫–∏': marketplaceFee,
            '–õ–æ–≥–∏—Å—Ç–∏–∫–∞': shippingCost,
            '–ù–∞–ª–æ–≥–∏': taxAmount
        }
    };
}

// Recommendations
function generateRecommendations(results, data) {
    const recs = [];
    
    if (results.margin < 20) {
        recs.push('üî¥ –ú–∞—Ä–∂–∞ –Ω–∏–∂–µ 20% ‚Äî –∑–æ–Ω–∞ —Ä–∏—Å–∫–∞. –ü–æ–¥—É–º–∞–π—Ç–µ –æ –ø–æ–≤—ã—à–µ–Ω–∏–∏ —Ü–µ–Ω—ã –∏–ª–∏ —Å–Ω–∏–∂–µ–Ω–∏–∏ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏.');
    } else if (results.margin < 40) {
        recs.push('üü° –ú–∞—Ä–∂–∞ 20-40% ‚Äî –¥–æ–ø—É—Å—Ç–∏–º–æ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞, –Ω–æ –µ—Å—Ç—å –∫—É–¥–∞ —Ä–∞—Å—Ç–∏. –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –∑–∞–∫—É–ø–∫–∏.');
    } else {
        recs.push('üü¢ –ú–∞—Ä–∂–∞ –≤—ã—à–µ 40% ‚Äî –∑–¥–æ—Ä–æ–≤—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å. –ú–æ–∂–Ω–æ –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ.');
    }
    
    if (results.laborCost > results.directCosts && results.directCosts > 0) {
        recs.push('‚è±Ô∏è –ó–∞—Ç—Ä–∞—Ç—ã –Ω–∞ —Ç—Ä—É–¥ –ø—Ä–µ–≤—ã—à–∞—é—Ç –º–∞—Ç–µ—Ä–∏–∞–ª—ã. –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏–ª–∏ –ø–æ–≤—ã—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.');
    }
    
    if (parseNum(data.marketplaceFee) > 15) {
        recs.push('üõí –í—ã—Å–æ–∫–∞—è –∫–æ–º–∏—Å—Å–∏—è –ø–ª–æ—â–∞–¥–∫–∏. –°—Ä–∞–≤–Ω–∏—Ç–µ —É—Å–ª–æ–≤–∏—è —Ä–∞–∑–Ω—ã—Ö –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤ –∏–ª–∏ —Ä–∞–∑–≤–∏–≤–∞–π—Ç–µ –ø—Ä—è–º—ã–µ –ø—Ä–æ–¥–∞–∂–∏.');
    }
    
    if (isFinite(results.breakEvenUnits) && results.breakEvenUnits > parseNum(data.monthlyVolume) * 0.8) {
        recs.push('üìâ –¢–æ—á–∫–∞ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏ –±–ª–∏–∑–∫–∞ –∫ –ø–ª–∞–Ω—É –ø—Ä–æ–¥–∞–∂. –£–≤–µ–ª–∏—á—å—Ç–µ –º–∞—Ä–∂—É –∏–ª–∏ —Å–Ω–∏–∑—å—Ç–µ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã.');
    }
    
    if (parseNum(data.overheadRent) > 0 && parseNum(data.monthlyVolume) < 30) {
        recs.push('üè¢ –ù–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ –µ–¥–∏–Ω–∏—Ü—É –≤—ã—Å–æ–∫–∏ –∏–∑-–∑–∞ –º–∞–ª–æ–≥–æ –æ–±—ä—ë–º–∞. –£–≤–µ–ª–∏—á—å—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –∏–ª–∏ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –∫–æ–≤–æ—Ä–∫–∏–Ω–≥.');
    }
    
    if (!isFinite(results.breakEvenUnits)) {
        recs.push('‚ö†Ô∏è –ü—Ä–∏ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω–µ –∏ –∑–∞—Ç—Ä–∞—Ç–∞—Ö —Ç–æ—á–∫–∞ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏ –Ω–µ–¥–æ—Å—Ç–∏–∂–∏–º–∞. –°—Ä–æ—á–Ω–æ –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å!');
    }
    
    if (recs.length === 0) {
        recs.push('‚úÖ –í–∞—à–∞ –º–æ–¥–µ–ª—å –≤—ã–≥–ª—è–¥–∏—Ç —É—Å—Ç–æ–π—á–∏–≤–æ–π. –°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ –æ–±—ä—ë–º–æ–≤ –ø—Ä–æ–¥–∞–∂ –∏ —É–¥–µ—Ä–∂–∞–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤.');
    }
    
    return recs;
}

// Risks
function generateRisks(results, data) {
    const risks = [];
    
    if (results.margin < 10) {
        risks.push({ risk: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –Ω–∏–∑–∫–∞—è –º–∞—Ä–∂–∞', desc: '–õ—é–±–æ–µ –∫–æ–ª–µ–±–∞–Ω–∏–µ —Ü–µ–Ω –Ω–∞ —Å—ã—Ä—å—ë –∏–ª–∏ –∫–æ–º–∏—Å—Å–∏–π –ø—Ä–∏–≤–µ–¥—ë—Ç –∫ —É–±—ã—Ç–∫–∞–º.', mitigation: '–°—Ä–æ—á–Ω–æ –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–∏—Ç–µ —Ü–µ–Ω—É –∏–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∑–∞—Ç—Ä–∞—Ç.' });
    }
    
    if (parseNum(data.taxRate) === 0) {
        risks.push({ risk: '–ù–µ —É—á—Ç–µ–Ω—ã –Ω–∞–ª–æ–≥–∏', desc: '–†–∞—Å—á—ë—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∏–±—ã–ª—å –¥–æ –Ω–∞–ª–æ–≥–æ–≤. –†–µ–∞–ª—å–Ω–∞—è –ø—Ä–∏–±—ã–ª—å –±—É–¥–µ—Ç –Ω–∏–∂–µ.', mitigation: '–î–æ–±–∞–≤—å—Ç–µ —Å—Ç–∞–≤–∫—É –Ω–∞–ª–æ–≥–∞ (–£–°–ù 6%, –ù–ü–î 4-6%) –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏.' });
    }
    
    if (parseNum(data.monthlyVolume) < 10) {
        risks.push({ risk: '–ú–∞–ª—ã–π –æ–±—ä—ë–º –ø—Ä–æ–¥–∞–∂', desc: '–ù–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –Ω–∞ –º–∞–ª–æ –µ–¥–∏–Ω–∏—Ü, –∑–∞–≤—ã—à–∞—è —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å.', mitigation: '–ü–µ—Ä–µ—Å—á–∏—Ç–∞–π—Ç–µ –ø—Ä–∏ —Ä–æ—Å—Ç–µ –æ–±—ä—ë–º–æ–≤ –∏–ª–∏ —Å–Ω–∏–∑—å—Ç–µ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã.' });
    }
    
    if (parseNum(data.shippingCost) > parseNum(data.sellingPrice) * 0.3 && parseNum(data.sellingPrice) > 0) {
        risks.push({ risk: '–í—ã—Å–æ–∫–∞—è –¥–æ–ª—è –ª–æ–≥–∏—Å—Ç–∏–∫–∏', desc: '–î–æ—Å—Ç–∞–≤–∫–∞ —Å—ä–µ–¥–∞–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—É—é —á–∞—Å—Ç—å –≤—ã—Ä—É—á–∫–∏.', mitigation: '–ü–µ—Ä–µ—Å–º–æ—Ç—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ—ã, –≤–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Å—É–º–º—É –∑–∞–∫–∞–∑–∞ –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏.' });
    }
    
    if (!isFinite(results.breakEvenUnits)) {
        risks.push({ risk: '–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è –º–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å', desc: '–ü—Ä–∏ —Ç–µ–∫—É—â–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö –∫–∞–∂–¥—ã–π –ø—Ä–æ–¥–∞–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä –ø—Ä–∏–Ω–æ—Å–∏—Ç —É–±—ã—Ç–æ–∫.', mitigation: '–£–≤–µ–ª–∏—á—å—Ç–µ —Ü–µ–Ω—É –ø—Ä–æ–¥–∞–∂–∏ –∏–ª–∏ —Å–Ω–∏–∑—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã.' });
    }
    
    if (risks.length === 0) {
        risks.push({ 
            risk: '–ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤–Ω–µ—à–Ω–∏—Ö —É—Å–ª–æ–≤–∏–π', 
            desc: '–¶–µ–Ω—ã –Ω–∞ —Å—ã—Ä—å—ë, –∫–æ–º–∏—Å—Å–∏–∏ –ø–ª–æ—â–∞–¥–æ–∫ –∏ –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç –º–æ–≥—É—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è.', 
            mitigation: '–ó–∞–ª–æ–∂–∏—Ç–µ –±—É—Ñ–µ—Ä 10-15% –≤ —Ü–µ–Ω—É –∏ —Ä–µ–≥—É–ª—è—Ä–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–π—Ç–µ –º–æ–¥–µ–ª—å.' 
        });
    }
    
    return risks;
}

// Render Functions
function renderCostBreakdown(breakdown, total) {
    const items = Object.entries(breakdown).filter(([_, val]) => val > 0);
    if (items.length === 0) {
        return '<div class="cost-item"><span class="label">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span><span class="value">0 ‚ÇΩ</span></div>';
    }
    
    return items.map(([label, value]) => {
        const percent = total > 0 ? (value / total) * 100 : 0;
        return `<div class="cost-item">
            <span class="label">${label}</span>
            <span class="value">${fmt(value)} ‚ÇΩ <small style="color:var(--text-muted)">(${fmt(percent, 1)}%)</small></span>
        </div>`;
    }).join('') + `<div class="cost-item total">
        <span class="label">–ò—Ç–æ–≥–æ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å</span>
        <span class="value">${fmt(total)} ‚ÇΩ</span>
    </div>`;
}

function renderRecommendations(list) {
    return list.map(rec => `<li>${rec}</li>`).join('');
}

function renderRisks(list) {
    return list.map(r => `
        <div class="risk-card">
            <strong>${r.risk}</strong>
            <p>${r.desc}</p>
            <div class="mitigation">${r.mitigation}</div>
        </div>
    `).join('');
}

// Charts
function renderCharts(breakdown, results, formData) {
    if (typeof Chart === 'undefined') {
        console.warn('Chart.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
        return;
    }
    
    const pieCanvas = document.getElementById('pieChart');
    if (!pieCanvas) return;
    
    const pieCtx = pieCanvas.getContext('2d');
    const pieLabels = Object.keys(breakdown).filter(k => breakdown[k] > 0);
    const pieData = pieLabels.map(k => breakdown[k]);
    const pieColors = ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6b7280', '#14b8a6'];
    
    if (pieChartInstance !== null) {
        pieChartInstance.destroy();
        pieChartInstance = null;
    }
    
    pieChartInstance = new Chart(pieCtx, {
        type: 'doughnut',
        data: {
            labels: pieLabels,
            datasets: [{
                data: pieData,
                backgroundColor: pieColors.slice(0, pieLabels.length),
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'right', labels: { font: { size: 12, family: 'Inter' } } },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a,b) => a+b, 0);
                            const percent = total > 0 ? ((value/total)*100).toFixed(1) : 0;
                            return `${label}: ${fmt(value)} ‚ÇΩ (${percent}%)`;
                        }
                    }
                }
            },
            cutout: '65%'
        }
    });
    
    const barCanvas = document.getElementById('barChart');
    if (!barCanvas) return;
    
    const barCtx = barCanvas.getContext('2d');
    const volumes = [10, 30, 50, 80, 100, 150];
    
    const totalOverhead = parseNum(formData.overheadRent) + parseNum(formData.overheadMarketing) + parseNum(formData.overheadOther);
    const taxRate = parseNum(formData.taxRate);
    const sellingPrice = results.sellingPrice;
    const variableCostPerUnit = results.totalCostPerUnit - results.overheadPerUnit;
    
    const profits = volumes.map(vol => {
        const overheadPerUnit = totalOverhead / vol;
        const costPerUnit = variableCostPerUnit + overheadPerUnit;
        const taxPerUnit = (sellingPrice * taxRate) / 100;
        const profitPerUnit = sellingPrice - costPerUnit - taxPerUnit;
        return Math.max(0, profitPerUnit * vol);
    });
    
    if (barChartInstance !== null) {
        barChartInstance.destroy();
        barChartInstance = null;
    }
    
    barChartInstance = new Chart(barCtx, {
        type: 'bar',
        data: {
            labels: volumes.map(v => `${v} —à—Ç`),
            datasets: [{
                label: '–ü—Ä–∏–±—ã–ª—å (‚ÇΩ)',
                data: profits,
                backgroundColor: profits.map(p => p > 0 ? '#10b981' : '#ef4444'),
                borderRadius: 8,
                borderSkipped: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { 
                    beginAtZero: true, 
                    grid: { color: '#e9eef2' },
                    ticks: { callback: (val) => fmtInt(val) + '‚ÇΩ' } 
                },
                x: { grid: { display: false } }
            }
        }
    });
}

// Form Handler
document.getElementById('calcForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    document.getElementById('loading').classList.add('show');
    document.getElementById('resultsSection').classList.remove('show');
    
    setTimeout(() => {
        const formData = {
            productName: document.getElementById('productName').value,
            sellingPrice: document.getElementById('sellingPrice').value,
            materialsCost: document.getElementById('materialsCost').value,
            packagingCost: document.getElementById('packagingCost').value,
            otherDirectCosts: document.getElementById('otherDirectCosts').value,
            laborMinutes: document.getElementById('laborMinutes').value,
            laborRate: document.getElementById('laborRate').value,
            overheadRent: document.getElementById('overheadRent').value,
            overheadMarketing: document.getElementById('overheadMarketing').value,
            overheadOther: document.getElementById('overheadOther').value,
            monthlyVolume: document.getElementById('monthlyVolume').value,
            marketplaceFee: document.getElementById('marketplaceFee').value,
            shippingCost: document.getElementById('shippingCost').value,
            taxRate: document.getElementById('taxRate').value,
            userEmail: document.getElementById('userEmail').value
        };
        
        calcResults = calculateUnitEconomics(formData);
        calcResults.productName = formData.productName;
        calcResults.userEmail = formData.userEmail;
        isCalculated = true;
        
        renderResults(calcResults, formData);
        
        document.getElementById('loading').classList.remove('show');
        document.getElementById('resultsSection').classList.add('show');
        document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        
        localStorage.setItem('unitCalcDraft', JSON.stringify(formData));
        
    }, 600);
});

function renderResults(results, formData) {
    if (!results || !results.totalCostPerUnit) {
        console.error('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á—ë—Ç–∞ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã');
        return;
    }
    
    document.getElementById('productTitle').textContent = results.productName || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
    document.getElementById('costPerUnit').textContent = `${fmt(results.totalCostPerUnit)} ‚ÇΩ`;
    document.getElementById('marginPercent').textContent = `${fmt(results.margin, 1)}%`;
    document.getElementById('markupPercent').textContent = `${fmt(results.markup, 1)}%`;
    
    const breakEvenEl = document.getElementById('breakEvenUnits');
    if (!isFinite(results.breakEvenUnits)) {
        breakEvenEl.textContent = '‚àû (–Ω–µ–¥–æ—Å—Ç–∏–∂–∏–º–æ)';
        breakEvenEl.parentElement.className = 'metric-card danger';
    } else {
        breakEvenEl.textContent = fmtInt(results.breakEvenUnits);
        const marginCard = document.querySelector('.metric-card.success');
        if (results.margin < 20) {
            marginCard.className = 'metric-card danger';
        } else if (results.margin < 40) {
            marginCard.className = 'metric-card warning';
        } else {
            marginCard.className = 'metric-card success';
        }
    }
    
    document.getElementById('costBreakdown').innerHTML = renderCostBreakdown(results.breakdown, results.totalCostPerUnit);
    
    const recs = generateRecommendations(results, formData);
    document.getElementById('recommendationsList').innerHTML = renderRecommendations(recs);
    
    const risks = generateRisks(results, formData);
    document.getElementById('risksList').innerHTML = renderRisks(risks);
    
    renderCharts(results.breakdown, results, formData);
    
    const emailSection = document.getElementById('emailSection');
    if (formData.userEmail && formData.userEmail.trim() !== '') {
        emailSection.style.display = 'block';
        document.getElementById('emailDisplay').textContent = formData.userEmail;
    } else {
        emailSection.style.display = 'none';
    }
    
    document.getElementById('csvPreview').style.display = 'none';
}

// Email
function sendEmail() {
    if (!isCalculated || !calcResults || !calcResults.totalCostPerUnit) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ä–∞—Å—á—ë—Ç, –∑–∞—Ç–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ –æ—Ç—á—ë—Ç');
        return;
    }
    
    const email = calcResults.userEmail;
    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email');
        return;
    }
    
    if (typeof emailjs === 'undefined') {
        alert('–°–µ—Ä–≤–∏—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å–µ–º –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç–∫—Å–ø–æ—Ä—Ç CSV.');
        return;
    }
    
    const btn = document.getElementById('sendEmailBtn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '‚è≥ –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç—á—ë—Ç...';
    
    const csvContent = generateCSV();
    const subject = `üìä –û—Ç—á—ë—Ç –ø–æ —é–Ω–∏—Ç-—ç–∫–æ–Ω–æ–º–∏–∫–µ: ${calcResults.productName || '–ü—Ä–æ–¥—É–∫—Ç'}`;
    
    const breakEvenText = isFinite(calcResults.breakEvenUnits) 
        ? `${fmtInt(calcResults.breakEvenUnits)} —à—Ç/–º–µ—Å` 
        : '–ù–µ–¥–æ—Å—Ç–∏–∂–∏–º–æ –ø—Ä–∏ —Ç–µ–∫—É—â–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö';
    
    const emailBody = `
–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!

–í–æ—Ç —Ä–∞—Å—á—ë—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏ —é–Ω–∏—Ç-—ç–∫–æ–Ω–æ–º–∏–∫–∏ –¥–ª—è –≤–∞—à–µ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞: "${calcResults.productName || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}"

üìà –ö–õ–Æ–ß–ï–í–´–ï –ü–û–ö–ê–ó–ê–¢–ï–õ–ò:
‚Ä¢ –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –µ–¥–∏–Ω–∏—Ü—ã: ${fmt(calcResults.totalCostPerUnit)} ‚ÇΩ
‚Ä¢ –ú–∞—Ä–∂–∞: ${fmt(calcResults.margin, 1)}%
‚Ä¢ –ù–∞—Ü–µ–Ω–∫–∞: ${fmt(calcResults.markup, 1)}%
‚Ä¢ –¢–æ—á–∫–∞ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏: ${breakEvenText}
‚Ä¢ ROI: ${fmt(calcResults.roi, 1)}%

üì¶ –°–¢–†–£–ö–¢–£–†–ê –ó–ê–¢–†–ê–¢ (–Ω–∞ 1 –µ–¥–∏–Ω–∏—Ü—É):
${Object.entries(calcResults.breakdown).filter(([_,v])=>v>0).map(([k,v])=>`‚Ä¢ ${k}: ${fmt(v)} ‚ÇΩ`).join('\n')}

üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:
${generateRecommendations(calcResults, {
    marketplaceFee: document.getElementById('marketplaceFee').value,
    monthlyVolume: document.getElementById('monthlyVolume').value,
    overheadRent: document.getElementById('overheadRent').value,
    shippingCost: document.getElementById('shippingCost').value,
    taxRate: document.getElementById('taxRate').value
}).map(r=>`‚Ä¢ ${r.replace(/^[üî¥üü°üü¢‚è±Ô∏èüõíüìâüè¢‚úÖ‚ö†Ô∏è]\s*/, '')}`).join('\n')}

üì• –î–ê–ù–ù–´–ï –î–õ–Ø –≠–ö–°–ü–û–†–¢–ê (CSV):
${csvContent}

---
–û—Ç—á—ë—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: ${new Date().toLocaleString('ru-RU')}
–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —é–Ω–∏—Ç-—ç–∫–æ–Ω–æ–º–∏–∫–∏ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)
    `.trim();
    
    const templateParams = {
        to_email: email,
        subject: subject,
        message: emailBody,
        from_name: "–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏"
    };
    
    emailjs.send('YOUR_SERVICE_ID', 'YOUR_TEMPLATE_ID', templateParams)
        .then(function(response) {
            alert('‚úÖ –û—Ç—á—ë—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ ' + email + '! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞–ø–∫—É "–°–ø–∞–º", –µ—Å–ª–∏ –Ω–µ –≤–∏–¥–∏—Ç–µ –ø–∏—Å—å–º–æ.');
            btn.innerHTML = '‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!';
            setTimeout(() => { btn.disabled = false; btn.innerHTML = originalText; }, 3000);
        }, function(error) {
            console.error('EmailJS Error:', error);
            alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç–∫—Å–ø–æ—Ä—Ç CSV.');
            btn.disabled = false;
            btn.innerHTML = originalText;
        });
}

// CSV Export
function generateCSV() {
    const breakEvenText = isFinite(calcResults.breakEvenUnits) 
        ? `${fmtInt(calcResults.breakEvenUnits)} —à—Ç/–º–µ—Å` 
        : '–ù–µ–¥–æ—Å—Ç–∏–∂–∏–º–æ';
    
    const rows = [
        ['–ü–∞—Ä–∞–º–µ—Ç—Ä', '–ó–Ω–∞—á–µ–Ω–∏–µ'],
        ['–ü—Ä–æ–¥—É–∫—Ç', calcResults.productName || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'],
        ['–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏', `${fmt(calcResults.sellingPrice)} ‚ÇΩ`],
        ['–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –µ–¥–∏–Ω–∏—Ü—ã', `${fmt(calcResults.totalCostPerUnit)} ‚ÇΩ`],
        ['–ú–∞—Ä–∂–∞', `${fmt(calcResults.margin, 1)}%`],
        ['–ù–∞—Ü–µ–Ω–∫–∞', `${fmt(calcResults.markup, 1)}%`],
        ['–¢–æ—á–∫–∞ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏', breakEvenText],
        ['ROI', `${fmt(calcResults.roi, 1)}%`],
        [],
        ['–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞—Ç—Ä–∞—Ç', ''],
        ...Object.entries(calcResults.breakdown).filter(([_,v])=>v>0).map(([k,v])=>[k, `${fmt(v)} ‚ÇΩ`]),
        [],
        ['–†–∞—Å—á—ë—Ç –ø—Ä–æ–∏–∑–≤–µ–¥—ë–Ω', new Date().toLocaleString('ru-RU')]
    ];
    
    return rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n');
}

function exportCSV(event) {
    if (!isCalculated || !calcResults || !calcResults.totalCostPerUnit) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ä–∞—Å—á—ë—Ç, –∑–∞—Ç–µ–º —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ');
        return;
    }
    
    const csv = generateCSV();
    const preview = document.getElementById('csvPreview');
    
    if (preview.style.display === 'none' || !preview.style.display) {
        preview.textContent = csv;
        preview.style.display = 'block';
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        const safeName = (calcResults.productName || 'product').replace(/[^a-z0-9–∞-—è—ë]/gi, '_');
        link.setAttribute('download', `unit-economics-${safeName}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        const btn = event.target;
        const original = btn.innerHTML;
        btn.innerHTML = '‚úÖ CSV —Å–∫–∞—á–∞–Ω!';
        setTimeout(() => btn.innerHTML = original, 2000);
    } else {
        preview.style.display = 'none';
    }
}

// Reset
function resetForm() {
    if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?')) {
        document.getElementById('calcForm').reset();
        document.getElementById('resultsSection').classList.remove('show');
        localStorage.removeItem('unitCalcDraft');
        
        if (pieChartInstance !== null) {
            pieChartInstance.destroy();
            pieChartInstance = null;
        }
        if (barChartInstance !== null) {
            barChartInstance.destroy();
            barChartInstance = null;
        }
        
        isCalculated = false;
        
        const marginCard = document.querySelector('.metric-card.success');
        if (marginCard) {
            marginCard.className = 'metric-card success';
        }
    }
}

// Load draft
window.addEventListener('load', function() {
    const draft = localStorage.getItem('unitCalcDraft');
    if (draft) {
        try {
            const data = JSON.parse(draft);
            Object.keys(data).forEach(key => {
                const el = document.getElementById(key);
                if (el && data[key] !== undefined) el.value = data[key];
            });
            const indicator = document.createElement('div');
            indicator.innerHTML = 'üìù –ß–µ—Ä–Ω–æ–≤–∏–∫ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ –ø–∞–º—è—Ç–∏ –±—Ä–∞—É–∑–µ—Ä–∞';
            indicator.style.cssText = 'background:var(--primary-soft); color:var(--primary-dark); padding:12px 20px; border-radius:var(--radius-sm); margin-bottom:20px; font-size:0.9rem; border:1px solid var(--primary-light);';
            const cardHeader = document.querySelector('#calcForm .card-header');
            if (cardHeader) {
                cardHeader.after(indicator);
                setTimeout(() => indicator.remove(), 5000);
            }
        } catch(e) { console.warn('Failed to load draft', e); }
    }
});

// Keyboard shortcut
document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        document.getElementById('calcForm').requestSubmit();
    }
});
</script>
</body>
</html>